<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Baustellen-Begehung (Mobil)</title>
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root { color-scheme: light dark; --bg:#f5f7fb; --card:#fff; --txt:#0f172a; --muted:#6b7280; --brand:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --fail:#dc2626; --na:#64748b; }
    *,*:before,*:after{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:900px;margin:auto;padding:14px}
    header{display:flex;align-items:center;gap:10px}
    h1{font-size:1.25rem;margin:10px 0}
    .card{background:var(--card);border-radius:14px;box-shadow:0 2px 8px rgba(2,6,23,.06);padding:14px;margin:12px 0}
    fieldset{border:none;margin:0;padding:0}
    legend{font-weight:700;margin-bottom:8px}
    label{display:block;font-weight:600;margin-top:10px}
    input[type=text],input[type=date],select,textarea{
      width:100%;padding:12px;border:1px solid #d4d8e1;border-radius:12px;background:#fff
    }
    textarea{min-height:74px}
    input[type=file]{margin-top:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{display:inline-block;background:var(--brand);color:#fff;border:none;padding:12px 16px;border-radius:12px;font-weight:700}
    .btn:disabled{opacity:.6}
    .muted{color:var(--muted);font-size:.9rem}
    .status{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .chip{padding:.35rem .6rem;border-radius:999px;border:1px solid #d4d8e1;cursor:pointer;user-select:none}
    .chip.active{border-color:var(--brand);background:rgba(14,165,233,.09)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .fail{color:var(--fail)} .na{color:var(--na)}
    .note{font-size:.95rem;margin-top:8px}
    .success{color:var(--ok)} .error{color:var(--fail)}
    .k{font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h10M4 17h7" stroke="#0ea5e9" stroke-width="2" stroke-linecap="round"/></svg>
      <h1>Baustellen-Begehung (Mobil)</h1>
    </header>

    <form id="form" class="card" autocomplete="on">
      <fieldset>
        <legend>Stammdaten</legend>
        <label>Berichtstitel
          <input required type="text" name="title" placeholder="[Begehung] Projekt XYZ – 2025-10-13" />
        </label>
        <div class="row">
          <label>Ort / Baustelle
            <input required type="text" name="ort" placeholder="z. B. Köln-Deutz, Wehr XYZ" />
          </label>
          <label>Datum
            <input required type="date" name="datum" />
          </label>
        </div>
        <div class="row">
          <label>Sifa / Ersteller
            <input required type="text" name="sifa" placeholder="Vorname Nachname" />
          </label>
          <label>Wetter (optional)
            <input type="text" name="wetter" placeholder="bewölkt, 15 °C, leicht windig" />
          </label>
        </div>
      </fieldset>
    </form>

    <div id="cats"></div>

    <div class="card">
      <fieldset>
        <legend>Zusammenfassung</legend>
        <label>Gesamteindruck / Hinweise / Maßnahmen
          <textarea name="summary" id="summary" placeholder="Freitext – wichtigste Punkte, Maßnahmen, Fristen …"></textarea>
        </label>
      </fieldset>
      <div class="note muted">
        Tipp: Die Seite kann per „Zum Home-Bildschirm hinzufügen“ als App-Icon gespeichert werden.
      </div>
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="sendBtn" type="button">Begehung absenden</button>
        <span id="status" class="note"></span>
      </div>
    </div>

    <div class="card muted">
      <div><span class="k">Hinweis zum Datenschutz: </span>Fotos werden in diesem Repo versioniert gespeichert (Uploads-Ordner). Es werden keine Tokens im Browser gespeichert – die Übergabe erfolgt serverseitig über Netlify-Functions.</div>
    </div>
  </div>

<script>
/* =================== Einstellungen =================== */
// 1) Netlify Function (später anlegen): Standardpfad bei Netlify:
const NETLIFY_ENDPOINT = "https://baustellenbegehung.netlify.app/.netlify/functions/submit-begehung";
// 2) Kategorien (Reihenfolge = Berichtreihenfolge)
const CATS = [
  "PSA & Zutritt",
  "Ordnung & Sauberkeit",
  "Verkehrswege & Absperrungen",
  "Erdarbeiten / Gräben / Wasserbau",
  "Gerüste & Leitern",
  "Krane & Hebezeuge / Anschlagmittel",
  "Maschinen & Geräte (inkl. Teleskopstapler)",
  "Elektrik & Beleuchtung",
  "Gefahrstoffe / Umweltschutz"
];
// 3) Status-Optionen
const STATUS = ["OK","Hinweis","Mangel","n.a."];

/* =================== UI bauen =================== */
function $(s){ return document.querySelector(s); }
function el(tag, attrs={}, html=""){ const e=document.createElement(tag); Object.assign(e, attrs); if(html) e.innerHTML = html; return e; }

function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().split("T")[0]; }
document.querySelector('input[name="datum"]').value = todayISO();

const catsWrap = $("#cats");
CATS.forEach((label, i) => {
  const id = "cat"+i;
  const card = el("div", {className:"card"});
  const fs = el("fieldset");
  fs.innerHTML = `<legend>${label}</legend>`;

  // Status-Chips
  const statusBox = el("div", {className:"status"});
  STATUS.forEach(st => {
    const chip = el("div", {className:"chip", dataset:{value:st}}, `${st}`);
    chip.classList.add(st==="OK"?"ok":st==="Hinweis"?"warn":st==="Mangel"?"fail":"na");
    chip.addEventListener("click", () => {
      [...statusBox.children].forEach(c=>c.classList.remove("active"));
      chip.classList.add("active");
      hidden.value = st;
    });
    statusBox.appendChild(chip);
  });
  const hidden = el("input",{type:"hidden",name:`status_${id}`,value:""});
  fs.appendChild(el("label",{}, "Status"));
  fs.appendChild(statusBox);
  fs.appendChild(hidden);

  // Bemerkungen
  const rem = el("label");
  rem.innerHTML = `Bemerkungen<input type="text" name="remark_${id}" placeholder="Kurzbeschreibung, Beobachtungen …" />`;
  fs.appendChild(rem);

  // Fotos
  const photo = el("label");
  photo.innerHTML = `Fotos / Nachweise (mehrere möglich)
    <input type="file" accept="image/*" capture="environment" name="photos_${id}" multiple />`;
  fs.appendChild(photo);

  card.appendChild(fs);
  catsWrap.appendChild(card);
});

/* =================== Helfer =================== */
function fileList(input){ return input && input.files ? Array.from(input.files) : []; }
function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload = ()=> resolve(r.result.split(",")[1]); // nur Base64
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}
function msg(text, cls=""){ const s=$("#status"); s.className="note "+cls; s.textContent=text; }

/* =================== Absenden =================== */
$("#sendBtn").addEventListener("click", async () => {
  const btn = $("#sendBtn");
  btn.disabled = true; msg("Übertrage …");

  try{
    // Stammdaten
    const fd = new FormData(document.getElementById("form"));
    const payload = {
      title: fd.get("title") || "[Begehung]",
      ort: fd.get("ort") || "",
      datum: fd.get("datum") || todayISO(),
      sifa: fd.get("sifa") || "",
      wetter: fd.get("wetter") || "",
      summary: $("#summary").value || "",
      categories: []
    };

    // Kategorien + Fotos
    for (let i=0;i<CATS.length;i++){
      const id = "cat"+i;
      const status = (document.querySelector(`input[name="status_${id}"]`)?.value || "").trim();
      const remark = (document.querySelector(`input[name="remark_${id}"]`)?.value || "").trim();
      const files = fileList(document.querySelector(`input[name="photos_${id}"]`));
      const photos = [];
      for (const f of files){ photos.push({filename:f.name, content: await fileToBase64(f)}); }
      payload.categories.push({label:CATS[i], status, remark, photos});
    }

    // Endpoint prüfen
    if (!NETLIFY_ENDPOINT || !NETLIFY_ENDPOINT.includes(".netlify.app")){
      throw new Error("NETLIFY_ENDPOINT ist nicht gesetzt. Bitte Function-URL im Code einfügen.");
    }

    // POST an Netlify-Function
    const res = await fetch(NETLIFY_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    const out = await res.json().catch(()=> ({}));
    if (!res.ok || !out.ok) throw new Error(out.error || `Fehler ${res.status}`);

    msg("Begehung übermittelt. PDF wird erzeugt …", "success");
    if (out.issue){
      const link = document.createElement("a");
      link.href = out.issue; link.target="_blank"; link.textContent = "Zum Issue";
      $("#status").append(" ", link);
    }
  }catch(e){
    console.error(e);
    msg("Fehler: "+ e.message, "error");
  }finally{
    btn.disabled = false;
  }
});
</script>
</body>
</html>

