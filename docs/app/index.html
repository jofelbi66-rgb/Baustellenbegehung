<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baustellen-Begehung (Mobil, komplett)</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --txt:#0e1116; --muted:#6b7280; --pri:#0a58ca; --ok:#16a34a; --warn:#f59e0b; --fail:#dc2626; --na:#64748b;
      --br:14px; --gap:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;gap:10px;margin:4px 0 16px}
    .top .burger{width:22px;height:2px;background:#999;position:relative;border-radius:2px}
    .top .burger::before,.top .burger::after{content:"";position:absolute;left:0;right:0;height:2px;background:#999;border-radius:2px}
    .top .burger::before{top:-6px}.top .burger::after{top:6px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:var(--br);box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px;margin-bottom:var(--gap)}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){ .row{grid-template-columns:1fr 1fr} }
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=date],input[type=text],textarea,select{
      width:100%;padding:12px 11px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font:inherit
    }
    textarea{min-height:120px;resize:vertical}

    /* Checkliste */
    .cl-head{display:grid;grid-template-columns:1fr 320px;gap:10px;font-size:12px;color:var(--muted);padding:0 6px 6px}
    @media(max-width:680px){ .cl-head{grid-template-columns:1fr} }
    .cl{display:flex;flex-direction:column;gap:10px}
    .item{display:grid;grid-template-columns:1fr 320px;gap:10px;align-items:flex-start;background:#fff;border:1px solid #eef1f5;border-radius:12px;padding:10px}
    @media(max-width:680px){ .item{grid-template-columns:1fr} }
    .item .cat{font-weight:600}
    .status{display:flex;gap:6px;flex-wrap:wrap}
    .status input{display:none}
    .chip{cursor:pointer;padding:8px 11px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-size:13px;user-select:none}
    .chip.ok{border-color:var(--ok);color:var(--ok)}
    .chip.warn{border-color:var(--warn);color:var(--warn)}
    .chip.fail{border-color:var(--fail);color:var(--fail)}
    .chip.na{border-color:var(--na);color:var(--na)}
    .status input:checked + .chip{background:currentColor;color:#fff}
    .status input:checked + .chip.ok{background:var(--ok)}
    .status input:checked + .chip.warn{background:var(--warn)}
    .status input:checked + .chip.fail{background:var(--fail)}
    .status input:checked + .chip.na{background:var(--na)}
    .tail{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tail input[type=file]{display:none}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #dbe1ea;background:#fff;cursor:pointer;font:inherit}
    .btn-primary{background:var(--pri);border-color:var(--pri);color:#fff}
    .muted{font-size:12px;color:var(--muted)}
    .photos{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .ph{width:54px;height:54px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}

    .footer-note{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="burger"></div>
      <h1>Baustellen-Begehung (Mobil)</h1>
    </div>

    <!-- Stammdaten -->
    <div class="card">
      <div class="row">
        <div>
          <label class="small">Berichtstitel</label>
          <input id="title" type="text" placeholder="[Begehung] Projekt XYZ – 2025-10-13">
        </div>
        <div>
          <label class="small">Datum</label>
          <input id="datum" type="date">
        </div>
        <div>
          <label class="small">Ort / Baustelle</label>
          <input id="ort" type="text" placeholder="z. B. Köln-Deutz, Wehr XYZ">
        </div>
        <div>
          <label class="small">Wetter (optional)</label>
          <input id="wetter" type="text" placeholder="bewölkt, 15 °C, leicht windig">
        </div>
        <div>
          <label class="small">Sifa / Ersteller</label>
          <input id="sifa" type="text" placeholder="Vorname Nachname">
        </div>
      </div>
    </div>

    <!-- Zusammenfassung -->
    <div class="card">
      <label class="small">Gesamteindruck / Hinweise / Maßnahmen</label>
      <textarea id="summary" placeholder="Wichtigste Punkte, Maßnahmen, Fristen …"></textarea>
    </div>

    <!-- Checkliste -->
    <div class="card">
      <div class="cl-head">
        <div>Kategorie</div>
        <div>Status / Bemerkungen & Fotos</div>
      </div>
      <div id="checklist" class="cl"></div>
    </div>

    <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="footer-note">
        Tipp: Diese Seite kann per „Zum Home-Bildschirm hinzufügen“ als App-Icon gespeichert werden.
      </div>
      <button id="submitBtn" class="btn btn-primary">Begehung absenden</button>
    </div>

    <div class="card muted">
      Hinweis zum Datenschutz: Fotos werden in diesem Repo versioniert gespeichert (Uploads-Ordner).
      Es werden keine Tokens im Browser gespeichert – die Übergabe erfolgt serverseitig über Netlify-Functions.
    </div>
  </div>

<script>
  // -------------------------------------------------------------
  // 1) Ziel-Endpunkt (Netlify Function) – bitte so lassen, das ist deine Function
  const NETLIFY_ENDPOINT =
    "https://baustellenbegehung.netlify.app/.netlify/functions/submit-begehung";

  // --- Kleine UI-Helfer für Statusmeldungen ---------------------
  function setStatus(msg, type = "info") {
    let box = document.getElementById("statusBox");
    if (!box) {
      box = document.createElement("div");
      box.id = "statusBox";
      box.style.position = "fixed";
      box.style.left = "50%";
      box.style.transform = "translateX(-50%)";
      box.style.bottom = "16px";
      box.style.zIndex = "9999";
      box.style.padding = "10px 14px";
      box.style.borderRadius = "10px";
      box.style.boxShadow = "0 2px 10px rgba(0,0,0,.12)";
      box.style.font = "14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif";
      box.style.maxWidth = "92vw";
      box.style.textAlign = "center";
      document.body.appendChild(box);
    }
    const colors = {
      info:   {bg:"#eff6ff", bd:"#bfdbfe", fg:"#1d4ed8"},
      ok:     {bg:"#ecfdf5", bd:"#a7f3d0", fg:"#065f46"},
      warn:   {bg:"#fffbeb", bd:"#fde68a", fg:"#92400e"},
      err:    {bg:"#fef2f2", bd:"#fecaca", fg:"#991b1b"}
    }[type] || {bg:"#f1f5f9", bd:"#e2e8f0", fg:"#0f172a"};

    box.style.background = colors.bg;
    box.style.border = "1px solid " + colors.bd;
    box.style.color = colors.fg;
    box.textContent = msg;
    box.style.display = "block";
    clearTimeout(box._t);
    box._t = setTimeout(()=> box.style.display="none", type==="err" ? 7000 : 3500);
  }

  // -------------------------------------------------------------
  // 2) Kategorien der Checkliste (wie gehabt)
  const CATEGORIES = [
    "PSA & Zutritt",
    "Ordnung & Sauberkeit",
    "Verkehrswege & Absperrungen",
    "Erdarbeiten / Gräben / Wasserbau",
    "Gerüste & Leitern",
    "Krane & Hebezeuge / Anschlagmittel",
    "Maschinen & Geräte (inkl. Teleskopstapler)",
    "Elektrik & Beleuchtung",
    "Gefahrstoffe / Umweltschutz"
  ];

  // -------------------------------------------------------------
  // 3) Checkliste aufbauen (unverändert)
  const cl = document.getElementById("checklist");
  CATEGORIES.forEach((cat, idx) => {
    const id = "cat_" + idx;

    const row = document.createElement("div");
    row.className = "item";
    row.dataset.cat = cat;

    const left = document.createElement("div");
    left.innerHTML = `<div class="cat">${cat}</div>`;
    row.appendChild(left);

    const right = document.createElement("div");

    const status = document.createElement("div");
    status.className = "status";

    const mk = (val, label, cls) => {
      const name = "status_" + id;
      const wrapper = document.createElement("label");
      wrapper.style.display = "inline-flex";

      const inp = document.createElement("input");
      inp.type = "radio";
      inp.name = name;
      inp.value = val;

      const chip = document.createElement("span");
      chip.className = "chip " + cls;
      chip.textContent = label;

      wrapper.appendChild(inp);
      wrapper.appendChild(chip);
      status.appendChild(wrapper);
    };

    mk("ok","OK","ok");
    mk("warn","Hinweis","warn");
    mk("fail","Mangel","fail");
    mk("na","n. a.","na");

    right.appendChild(status);

    const remark = document.createElement("input");
    remark.type = "text";
    remark.placeholder = "Bemerkung (optional)";
    remark.style.marginTop = "8px";
    remark.dataset.remark = "1";
    right.appendChild(remark);

    // (Fotos/Signatur kommen in Schritt 2/3 dazu)
    row.appendChild(right);
    cl.appendChild(row);
  });

  // -------------------------------------------------------------
  // 4) Submit-Logik – robust & mit klaren Fehlermeldungen
  document.getElementById("submitBtn").addEventListener("click", async () => {
    const payload = collectData();

    // Minimale Plausibilität:
    if (!payload.title) {
      setStatus("Bitte einen Berichtstitel eingeben.", "warn");
      return;
    }
    if (!payload.datum) {
      setStatus("Bitte ein Datum wählen.", "warn");
      return;
    }

    // Debug-Anzeige (kannst du später entfernen)
    console.log("Sende Payload:", payload);

    // Senden
    try {
      setStatus("Sende Begehung …", "info");
      const res = await sendBegehung(payload);
      if (!res.ok) {
        setStatus("Fehler: " + (res.error || "unbekannt") , "err");
        console.error("Function-Fehler:", res);
        return;
      }
      setStatus("Begehung übermittelt! (Issue #" + res.number + ")", "ok");
      // Zeig den Link zum Issue:
      if (res.issue) {
        // Button anzeigen:
        const open = confirm("Bericht erfolgreich erstellt.\nJetzt im Repository öffnen?");
        if (open) window.open(res.issue, "_blank");
      }
    } catch (e) {
      setStatus("Unerwarteter Fehler: " + e.message, "err");
      console.error(e);
    }
  });

  function collectData(){
    const data = {
      title: getVal("title"),
      datum: getVal("datum"),
      ort: getVal("ort"),
      sifa: getVal("sifa"),
      wetter: getVal("wetter"),
      summary: getVal("summary"),
      categories: []
    };

    document.querySelectorAll(".item").forEach(row => {
      const cat = row.dataset.cat;
      const status = row.querySelector('input[type=radio]:checked')?.value || "";
      const remark = row.querySelector('input[data-remark]')?.value || "";
      data.categories.push({ cat, status, remark });
    });

    return data;
  }

  function getVal(id){ return document.getElementById(id)?.value?.trim() || "" }

  async function sendBegehung(payload){
    // Wichtig: mode:'cors' & explizite Fehlerbehandlung
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 25000); // 25s Timeout

    try{
      const res = await fetch(NETLIFY_ENDPOINT, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      clearTimeout(timeout);

      // Bei nicht 2xx:
      if (!res.ok) {
        let text;
        try { text = await res.text(); } catch {}
        return { ok:false, error: text || ("HTTP " + res.status) };
      }

      // Erwartet: { ok:true, number: <num>, issue: <url> }
      const json = await res.json();
      return json;
    }catch(e){
      clearTimeout(timeout);
      if (e.name === "AbortError") {
        return { ok:false, error:"Zeitüberschreitung (Timeout) beim Senden" };
      }
      return { ok:false, error: e.message || "Netzwerkfehler" };
    }
  }

  // Datum vorbefüllen
  (function presetDate(){
    const d = new Date();
    const iso = d.toISOString().slice(0,10);
    document.getElementById("datum").value = iso;
  })();
</script>
</body>
</html>
