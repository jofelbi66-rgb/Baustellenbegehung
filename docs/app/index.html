<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Baustellen-Begehung (Mobil, komplett)</title>
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --txt:#0e1116; --muted:#6b7280; --pri:#0a58ca; --ok:#16a34a; --warn:#f59e0b; --fail:#dc2626; --na:#64748b;
      --br:14px; --gap:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;gap:10px;margin:4px 0 16px}
    .top .burger{width:22px;height:2px;background:#999;position:relative;border-radius:2px}
    .top .burger::before,.top .burger::after{content:"";position:absolute;left:0;right:0;height:2px;background:#999;border-radius:2px}
    .top .burger::before{top:-6px}.top .burger::after{top:6px}
    h1{font-size:20px;margin:0}
    .card{background:var(--card);border-radius:var(--br);box-shadow:0 1px 3px rgba(0,0,0,.06);padding:16px;margin-bottom:var(--gap)}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:680px){ .row{grid-template-columns:1fr 1fr} }
    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type=date],input[type=text],textarea,select{
      width:100%;padding:12px 11px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;font:inherit
    }
    textarea{min-height:120px;resize:vertical}

    /* Checkliste */
    .cl-head{display:grid;grid-template-columns:1fr 320px;gap:10px;font-size:12px;color:var(--muted);padding:0 6px 6px}
    @media(max-width:680px){ .cl-head{grid-template-columns:1fr} }
    .cl{display:flex;flex-direction:column;gap:10px}
    .item{display:grid;grid-template-columns:1fr 320px;gap:10px;align-items:flex-start;background:#fff;border:1px solid #eef1f5;border-radius:12px;padding:10px}
    @media(max-width:680px){ .item{grid-template-columns:1fr} }
    .item .cat{font-weight:600}
    .status{display:flex;gap:6px;flex-wrap:wrap}
    .status input{display:none}
    .chip{cursor:pointer;padding:8px 11px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;font-size:13px;user-select:none}
    .chip.ok{border-color:var(--ok);color:var(--ok)}
    .chip.warn{border-color:var(--warn);color:var(--warn)}
    .chip.fail{border-color:var(--fail);color:var(--fail)}
    .chip.na{border-color:var(--na);color:var(--na)}
    .status input:checked + .chip{background:currentColor;color:#fff}
    .status input:checked + .chip.ok{background:var(--ok)}
    .status input:checked + .chip.warn{background:var(--warn)}
    .status input:checked + .chip.fail{background:var(--fail)}
    .status input:checked + .chip.na{background:var(--na)}
    .tail{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .tail input[type=file]{display:none}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #dbe1ea;background:#fff;cursor:pointer;font:inherit}
    .btn-primary{background:var(--pri);border-color:var(--pri);color:#fff}
    .muted{font-size:12px;color:var(--muted)}
    .photos{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .ph{width:54px;height:54px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb}

    .footer-note{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="burger"></div>
      <h1>Baustellen-Begehung (Mobil)</h1>
    </div>

    <!-- Stammdaten -->
    <div class="card">
      <div class="row">
        <div>
          <label class="small">Berichtstitel</label>
          <input id="title" type="text" placeholder="[Begehung] Projekt XYZ – 2025-10-13">
        </div>
        <div>
          <label class="small">Datum</label>
          <input id="datum" type="date">
        </div>
        <div>
          <label class="small">Ort / Baustelle</label>
          <input id="ort" type="text" placeholder="z. B. Köln-Deutz, Wehr XYZ">
        </div>
        <div>
          <label class="small">Wetter (optional)</label>
          <input id="wetter" type="text" placeholder="bewölkt, 15 °C, leicht windig">
        </div>
        <div>
          <label class="small">Sifa / Ersteller</label>
          <input id="sifa" type="text" placeholder="Vorname Nachname">
        </div>
      </div>
    </div>

    <!-- Zusammenfassung -->
    <div class="card">
      <label class="small">Gesamteindruck / Hinweise / Maßnahmen</label>
      <textarea id="summary" placeholder="Wichtigste Punkte, Maßnahmen, Fristen …"></textarea>
    </div>

    <!-- Checkliste -->
    <div class="card">
      <div class="cl-head">
        <div>Kategorie</div>
        <div>Status / Bemerkungen & Fotos</div>
      </div>
      <div id="checklist" class="cl"></div>
    </div>

    <div class="card" style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="footer-note">
        Tipp: Diese Seite kann per „Zum Home-Bildschirm hinzufügen“ als App-Icon gespeichert werden.
      </div>
      <button id="submitBtn" class="btn btn-primary">Begehung absenden</button>
    </div>

    <div class="card muted">
      Hinweis zum Datenschutz: Fotos werden in diesem Repo versioniert gespeichert (Uploads-Ordner).
      Es werden keine Tokens im Browser gespeichert – die Übergabe erfolgt serverseitig über Netlify-Functions.
    </div>
  </div>

<script>
  // -------------------------------------------------------------
  // 1) Ziel-Endpunkt (Netlify Function)
  //    -> falls du die Function-URL änderst, hier anpassen:
  const NETLIFY_ENDPOINT =
    "https://baustellenbegehung.netlify.app/.netlify/functions/submit-begehung";

  // -------------------------------------------------------------
  // 2) Kategorien der Checkliste (kannst du hier frei erweitern)
  const CATEGORIES = [
    "PSA & Zutritt",
    "Ordnung & Sauberkeit",
    "Verkehrswege & Absperrungen",
    "Erdarbeiten / Gräben / Wasserbau",
    "Gerüste & Leitern",
    "Krane & Hebezeuge / Anschlagmittel",
    "Maschinen & Geräte (inkl. Teleskopstapler)",
    "Elektrik & Beleuchtung",
    "Gefahrstoffe / Umweltschutz"
  ];

  // -------------------------------------------------------------
  // 3) UI: Checkliste dynamisch aufbauen
  const cl = document.getElementById("checklist");

  CATEGORIES.forEach((cat, idx) => {
    const id = "cat_" + idx;

    const row = document.createElement("div");
    row.className = "item";
    row.dataset.cat = cat;

    // Linke Spalte: Kategoriename
    const left = document.createElement("div");
    left.innerHTML = `<div class="cat">${cat}</div>`;
    row.appendChild(left);

    // Rechte Spalte: Status-Badges + Bemerkungen + Fotos
    const right = document.createElement("div");

    const status = document.createElement("div");
    status.className = "status";

    const mk = (val, label, cls) => {
      const name = "status_" + id;
      const wrapper = document.createElement("label");
      wrapper.style.display = "inline-flex";

      const inp = document.createElement("input");
      inp.type = "radio";
      inp.name = name;
      inp.value = val;

      const chip = document.createElement("span");
      chip.className = "chip " + cls;
      chip.textContent = label;

      wrapper.appendChild(inp);
      wrapper.appendChild(chip);
      status.appendChild(wrapper);
    };

    mk("ok","OK","ok");
    mk("warn","Hinweis","warn");
    mk("fail","Mangel","fail");
    mk("na","n. a.","na");

    right.appendChild(status);

    const remark = document.createElement("input");
    remark.type = "text";
    remark.placeholder = "Bemerkung (optional)";
    remark.style.marginTop = "8px";
    remark.dataset.remark = "1";
    right.appendChild(remark);

    const tail = document.createElement("div");
    tail.className = "tail";

    // Foto-Upload
    const fileId = "file_" + id;
    const file = document.createElement("input");
    file.type = "file";
    file.accept = "image/*";
    file.capture = "environment";
    file.multiple = true;
    file.id = fileId;

    const fileBtn = document.createElement("label");
    fileBtn.className = "btn";
    fileBtn.htmlFor = fileId;
    fileBtn.textContent = "Fotos aufnehmen / auswählen";

    const photos = document.createElement("div");
    photos.className = "photos";

    file.addEventListener("change", () => {
      photos.innerHTML = "";
      Array.from(file.files).forEach(f => {
        const url = URL.createObjectURL(f);
        const img = document.createElement("img");
        img.className = "ph";
        img.src = url;
        photos.appendChild(img);
      });
    });

    tail.appendChild(file);
    tail.appendChild(fileBtn);
    right.appendChild(tail);
    right.appendChild(photos);

    row.appendChild(right);
    cl.appendChild(row);
  });

  // -------------------------------------------------------------
  // 4) Submit
  document.getElementById("submitBtn").addEventListener("click", async () => {
    try {
      const payload = collectData();
      const res = await sendBegehung(payload);
      if(!res.ok){
        alert("Fehler beim Absenden: " + (res.error || "unbekannt"));
      }else{
        alert("Begehung wurde übermittelt! Issue #" + res.number);
        // optional: Weiterleitung zur Issue-URL
        if(res.issue) window.open(res.issue, "_blank");
      }
    } catch(e){
      console.error(e);
      alert("Unerwarteter Fehler: " + e.message);
    }
  });

  function collectData(){
    const data = {
      title: getVal("title"),
      datum: getVal("datum"),
      ort: getVal("ort"),
      sifa: getVal("sifa"),
      wetter: getVal("wetter"),
      summary: getVal("summary"),
      categories: []
    };

    document.querySelectorAll(".item").forEach(row => {
      const cat = row.dataset.cat;
      const status = row.querySelector('input[type=radio]:checked')?.value || "";
      const remark = row.querySelector('input[data-remark]')?.value || "";

      const files = row.querySelector('input[type=file]')?.files || [];
      const photos = Array.from(files);

      data.categories.push({ cat, status, remark, photosCount: photos.length });
    });

    return data;
  }

  function getVal(id){ return document.getElementById(id)?.value?.trim() || "" }

  async function sendBegehung(payload){
    // Hinweis:
    // Hier senden wir nur die Metadaten (Fotos werden im
    // bestehenden Flow über die Function verarbeitet).
    const res = await fetch(NETLIFY_ENDPOINT, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      let txt = await res.text();
      return { ok:false, error: txt || ("HTTP "+res.status) };
    }
    return res.json();
  }

  // Datum vorbefüllen
  (function presetDate(){
    const d = new Date();
    const iso = d.toISOString().slice(0,10);
    document.getElementById("datum").value = iso;
  })();
</script>
</body>
</html>
